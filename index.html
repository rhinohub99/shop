<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Supabase Chat</title>
  <style>
    body { font-family: Arial; display:flex; justify-content:center; margin-top:50px; }
    #chat { width:400px; }
    #messages { border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px; margin-bottom:10px; }
    #input { display:flex; gap:5px; }
    #input input { flex:1; padding:5px; }
    #error { color:red; margin-top:5px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="chat">
    <h2>Chat Room</h2>
    <div id="messages"></div>
    <div id="input">
      <input id="username" placeholder="Your name" />
      <input id="text" placeholder="Message" />
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="error"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://gmlyelaprombqbryzojb.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtbHllbGFwcm9tYnFicnl6b2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNDQyNDUsImV4cCI6MjA4MzkyMDI0NX0.ke8C9OEV66O9IhAKVsmRaHFOduta5FrK6Z6hRHbSs2w"

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const messagesEl = document.getElementById("messages")
    const errorEl = document.getElementById("error")

    // Listen for new messages
    supabase
      .channel('messages')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        const msg = payload.new
        const div = document.createElement("div")
        div.textContent = msg.username + ": " + msg.message
        messagesEl.append(div)
        messagesEl.scrollTop = messagesEl.scrollHeight
      })
      .subscribe()

    async function sendMessage() {
      const username = document.getElementById("username").value
      const text = document.getElementById("text").value
      if (!username || !text) return

      try {
        const { error } = await supabase.from('messages').insert([{ username, message: text }])
        if (error) {
          errorEl.textContent = "Error sending message: " + error.message
        } else {
          document.getElementById("text").value = ""
          errorEl.textContent = ""
        }
      } catch (e) {
        errorEl.textContent = "Unexpected error: " + e.message
      }
    }
  </script>
</body>
</html>
